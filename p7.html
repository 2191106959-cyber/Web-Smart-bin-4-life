<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞</title>
<script src="jQueryAssets/jquery-1.11.1.min.js"></script> <script type="text/javascript">
function MM_preloadImages() { //v3.0
  var d=document; if(d.images){ if(!d.MM_p) d.MM_p=new Array();
    var i,j=d.MM_p.length,a=MM_preloadImages.arguments; for(i=0; i<a.length; i++)
    if (a[i].indexOf("#")!=0){ d.MM_p[j]=new Image; d.MM_p[j++].src=a[i];}}
}
function MM_swapImgRestore() { //v3.0
  var i,x,a=document.MM_sr; for(i=0;a&&i<a.length&&(x=a[i])&&x.oSrc;i++) x.src=x.oSrc;
}
function MM_findObj(n, d) { //v4.01
  var p,i,x;  if(!d) d=document; if((p=n.indexOf("?"))>0&&parent.frames.length) {
    d=parent.frames[n.substring(p+1)].document; n=n.substring(0,p);}
  if(!(x=d[n])&&d.all) x=d.all[n]; for (i=0;!x&&i<d.forms.length;i++) x=d.forms[i][n];
  for(i=0;!x&&d.layers&&i<d.layers.length;i++) x=MM_findObj(n,d.layers[i].document);
  if(!x && d.getElementById) x=d.getElementById(n); return x;
}

function MM_swapImage() { //v3.0
  var i,j=0,x,a=MM_swapImage.arguments; document.MM_sr=new Array; for(i=0;i<(a.length-2);i+=3)
   if ((x=MM_findObj(a[i]))!=null){document.MM_sr[j++]=x; if(!x.oSrc) x.oSrc=x.src; x.src=a[i+2];}
}
</script>
<style type="text/css">
body,td,th {
    font-family: "FC Mission Rounded [Non-cml.]";
    font-size: 18px;
}
body {
    background-color: #BCD4FF;
}
</style>
</head>

<body onLoad="MM_preloadImages('img/images/D-_Wed-Smatr-bin4life_img_images_Untitled-1_07.gif','img/images/D-_Wed-Smatr-bin4life_img_images_Untitled-1_03.gif','img/images/D-_Wed-Smatr-bin4life_img_images_Untitled-1_05.gif','img/images/D-_Wed-Smatr-bin4life_img_images_Untitled-1_06.gif')">
<table width="1024" border="0" align="center" cellpadding="0" cellspacing="0">
  <tbody>
    <tr>
      <td width="1023" colspan="4"><img src="img/images/Untitled-3.gif" width="1024" height="200" alt=""/></td>
    </tr>
    <tr>
      <td><strong><a href="index.html" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('Image4','','img/images/D-_Wed-Smatr-bin4life_img_images_Untitled-1_07.gif',1)"><img src="img/images/Untitled-2_07.gif" alt="" width="229" height="59" id="Image4"></a></strong></td>
      <td><strong><a href="p2.html" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('Image5','','img/images/D-_Wed-Smatr-bin4life_img_images_Untitled-1_03.gif',1)"><img src="img/images/Untitled-2_03.gif" alt="" width="283" height="59" id="Image5"></a></strong></td>
      <td><strong><a href="p3.html" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('Image6','','img/images/D-_Wed-Smatr-bin4life_img_images_Untitled-1_05.gif',1)"><img src="img/images/Untitled-2_05.gif" alt="" width="298" height="59" id="Image6"></a></strong></td>
      <td><strong><a href="p4.html" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('Image7','','img/images/D-_Wed-Smatr-bin4life_img_images_Untitled-1_06.gif',1)"><img src="img/images/Untitled-2_06.gif" alt="" width="213" height="59" id="Image7"></a></strong></td>
    </tr>
    <tr>
      <td><strong><a href="index.html" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('Image4','','img/images/D-_Wed-Smatr-bin4life_img_images_Untitled-1_07.gif',1)"><img src="img/images/Untitled-2_07.gif" alt="" width="229" height="59" id="Image23"></a></strong></td>
      <td><strong><a href="p2.html" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('Image5','','img/images/D-_Wed-Smatr-bin4life_img_images_Untitled-1_03.gif',1)"><img src="img/images/Untitled-2_03.gif" alt="" width="283" height="59" id="Image24"></a></strong></td>
      <td><strong><a href="p3.html" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('Image6','','img/images/D-_Wed-Smatr-bin4life_img_images_Untitled-1_05.gif',1)"><img src="img/images/Untitled-2_05.gif" alt="" width="298" height="59" id="Image25"></a></strong></td>
      <td><strong><a href="p4.html" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('Image7','','img/images/D-_Wed-Smatr-bin4life_img_images_Untitled-1_06.gif',1)"><img src="img/images/Untitled-2_06.gif" alt="" width="213" height="59" id="Image26"></a></strong></td>
    </tr>
    <tr>
      <td height="42" colspan="4" bgcolor="#98D48B"><marquee>
        ‡∏Ñ‡∏±‡∏î‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞‡∏á‡πà‡∏≤‡∏¢ ‡πÜ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏£‡∏≤
      </marquee></td>
    </tr>
    <tr>
      <td height="512" colspan="4" align="center" valign="top" bgcolor="#DFEEC8"><p><title>‚ôªÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞</title>
        <!-- Tailwind CSS CDN -->
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
        <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styling for list scroll */
        #points-log-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 0.5rem; /* Space for scrollbar */
        }
        /* Hide default number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
  </head>
  <body class="bg-gray-50 flex flex-col items-center p-4 min-h-screen">
        
        <!-- Loading Spinner -->
      <div id="loading-screen" class="flex items-center justify-center min-h-screen fixed inset-0 bg-gray-50 z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500"></div>
        <p class="ml-3 text-lg text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö... (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</p>
    </div>

    <!-- Main Application Container -->
    <div id="app-root" class="w-full max-w-lg hidden">
        <header class="w-full text-center my-8">
            <h1 class="text-4xl font-extrabold text-green-700 tracking-tight">
                ‚ôªÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞
            </h1>
            <p class="text-gray-500 mt-2">
                ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="user-id-display" class="font-mono text-xs p-1 bg-gray-200 rounded-md select-all"></span>
            </p>
        </header>

        <main class="bg-white shadow-2xl rounded-xl p-6 md:p-8 space-y-8">
            <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° -->
            <div class="bg-green-600 text-white p-6 rounded-lg shadow-xl text-center transition-transform hover:scale-[1.01]">
                <p class="text-xl font-medium opacity-90">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏£‡∏ß‡∏°</p>
                <p id="total-points" class="text-6xl font-black mt-2">0</p>
                <p class="mt-2 text-sm">‡πÅ‡∏ï‡πâ‡∏°</p>
            </div>

            <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡∏°‡πà -->
            <section>
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                    ‚ûï ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞
                </h2>
                <form id="add-points-form" class="space-y-4">
                    <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏¢‡∏∞ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏¢‡∏∞
                        </label>
                        <div id="waste-type-buttons" class="flex flex-wrap gap-2">
                            <!-- Buttons rendered by JS -->
                        </div>
                    </div>

                    <!-- ‡πÉ‡∏™‡πà‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -->
                    <div>
                        <label for="points" class="block text-sm font-medium text-gray-700 mb-1">
                            ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 15 ‡πÅ‡∏ï‡πâ‡∏°)
                        </label>
                        <input
                            id="input-points"
                            type="number"
                            min="1"
                            max="15"
                            class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500 text-lg"
                            placeholder="‡πÄ‡∏ä‡πà‡∏ô 10"
                            required
                        />
                    </div>

                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
                    <button
                        type="submit"
                        id="save-button"
                        class="w-full py-3 px-4 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                    </button>
                </form>
                <p id="error-message" class="mt-3 text-center p-2 rounded-md hidden"></p>
            </section>

            <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -->
            <section class="mt-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                    üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (<span id="log-count">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
                </h2>
                <div id="no-log-message" class="text-gray-500 text-center p-4 border rounded-lg hidden">
                    üëã ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å‡πÄ‡∏•‡∏¢!
                </div>
                <ul id="points-log-list" class="space-y-3 pr-2">
                    <!-- Log entries rendered by JS -->
                </ul>
            </section>

            <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
            <section class="pt-4 border-t border-gray-100">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                    ‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </h2>
                <button
                    id="reset-button"
                    class="w-full py-3 px-4 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg shadow transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled
                >
                    üö® ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
            </section>
        </main>
    </div>

    <!-- JavaScript Logic (using type="module" for Firebase imports) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, deleteDoc, doc, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global State & Constants ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'recycling-points-app';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        const wasteTypes = [
            { key: 'plastic', name: '‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å', emoji: 'ü•§', color: 'bg-green-500/80', activeClass: 'ring-green-400' },
            { key: 'paper', name: '‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©', emoji: 'üì∞', color: 'bg-blue-500/80', activeClass: 'ring-blue-400' },
            { key: 'glass', name: '‡πÅ‡∏Å‡πâ‡∏ß', emoji: 'üçæ', color: 'bg-indigo-500/80', activeClass: 'ring-indigo-400' },
            { key: 'metal', name: '‡πÇ‡∏•‡∏´‡∏∞', emoji: 'ü•´', color: 'bg-yellow-500/80', activeClass: 'ring-yellow-400' },
        ];

        const MAX_POINTS_PER_ENTRY = 15;

        // Firebase instances
        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false;
        let selectedRecycleType = wasteTypes[0].key;
        let pointsLog = [];
        let isResetting = false;

        // --- DOM Elements ---
        const loadingScreen = document.getElementById('loading-screen');
        const appRoot = document.getElementById('app-root');
        const userIdDisplay = document.getElementById('user-id-display');
        const totalPointsDisplay = document.getElementById('total-points');
        const wasteTypeButtonsContainer = document.getElementById('waste-type-buttons');
        const inputPoints = document.getElementById('input-points');
        const saveButton = document.getElementById('save-button');
        const errorMessageDisplay = document.getElementById('error-message');
        const addPointsForm = document.getElementById('add-points-form');
        const logCountDisplay = document.getElementById('log-count');
        const noLogMessage = document.getElementById('no-log-message');
        const pointsLogList = document.getElementById('points-log-list');
        const resetButton = document.getElementById('reset-button');

        // --- Utility Functions ---

        /**
         * ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ
         * @param {number} num 
         * @returns {string}
         */
        const formatNumber = (num) => {
            return num.toLocaleString('th-TH');
        };

        /**
         * ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î/‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
         * @param {string} message 
         * @param {boolean} isSuccess 
         */
        const displayError = (message, isSuccess = false) => {
            errorMessageDisplay.textContent = message;
            errorMessageDisplay.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            
            if (isSuccess) {
                errorMessageDisplay.classList.add('bg-green-100', 'text-green-700');
                // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                setTimeout(() => { errorMessageDisplay.classList.add('hidden'); }, 3000);
            } else {
                errorMessageDisplay.classList.add('bg-red-100', 'text-red-700');
            }
        };

        /**
         * ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
         */
        const clearError = () => {
             errorMessageDisplay.classList.add('hidden');
        };


        // --- UI Rendering ---

        /**
         * ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏¢‡∏∞
         */
        const renderWasteTypeButtons = () => {
            wasteTypeButtonsContainer.innerHTML = '';
            wasteTypes.forEach(type => {
                const button = document.createElement('button');
                button.type = 'button';
                button.textContent = `${type.emoji} ${type.name}`;
                button.className = `flex items-center px-4 py-2 rounded-full text-white font-medium shadow-md transition-all`;
                
                const isSelected = type.key === selectedRecycleType;
                
                if (isSelected) {
                    button.classList.add(type.color.replace('/80', ''), `ring-4`, `ring-offset-2`, `ring-green-400`);
                } else {
                    button.classList.add('bg-gray-400', 'hover:bg-gray-500');
                }

                button.onclick = () => {
                    selectedRecycleType = type.key;
                    renderWasteTypeButtons(); // Re-render to update active state
                };
                wasteTypeButtonsContainer.appendChild(button);
            });
        };

        /**
         * ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
         */
        const renderPointsLog = () => {
            pointsLogList.innerHTML = '';
            logCountDisplay.textContent = pointsLog.length;

            if (pointsLog.length === 0) {
                noLogMessage.classList.remove('hidden');
                resetButton.disabled = true;
                return;
            }

            noLogMessage.classList.add('hidden');
            resetButton.disabled = isResetting;
            
            pointsLog.forEach(item => {
                const typeInfo = wasteTypes.find(t => t.key === item.type) || { emoji: '‚ùì', name: '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö' };
                const listItem = document.createElement('li');
                listItem.className = "flex items-center justify-between p-3 bg-gray-50 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition duration-150";
                
                const timestamp = item.timestamp instanceof Date ? item.timestamp : new Date(); // Fallback in case conversion failed

                listItem.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">${typeInfo.emoji}</span>
                        <div>
                            <p class="font-semibold text-gray-800">${typeInfo.name}</p>
                            <p class="text-xs text-gray-500">
                                ${timestamp.toLocaleDateString('th-TH', {
                                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                                })}
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <p class="text-xl font-bold text-green-600">
                            +${item.points}
                        </p>
                        <button
                            data-id="${item.id}"
                            class="delete-entry-btn text-gray-400 hover:text-red-500 transition"
                            title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
                pointsLogList.appendChild(listItem);
            });

            // Attach delete handlers after rendering
            pointsLogList.querySelectorAll('.delete-entry-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    handleDeleteEntry(id);
                });
            });
        };

        /**
         * ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°
         */
        const updateTotalPoints = () => {
            const total = pointsLog.reduce((sum, item) => sum + item.points, 0);
            totalPointsDisplay.textContent = formatNumber(total);
        };

        // --- Firebase Handlers ---

        /**
         * Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö Real-time ‡∏à‡∏≤‡∏Å Firestore
         */
        const setupFirestoreListener = () => {
            if (!db || !userId) {
                console.error("Firestore or User ID is not ready.");
                return;
            }

            const collectionPath = `artifacts/${appId}/users/${userId}/recycling_log`;
            const logsCollection = collection(db, collectionPath);
            const q = query(logsCollection);

            // onSnapshot listener
            onSnapshot(q, (snapshot) => {
                const logs = snapshot.docs.map(doc => {
                    const data = doc.data();
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á Timestamp ‡πÄ‡∏õ‡πá‡∏ô Date Object
                    const timestamp = data.timestamp && data.timestamp.toDate ? data.timestamp.toDate() : new Date();

                    return {
                        id: doc.id,
                        type: data.type,
                        points: Number(data.points),
                        timestamp: timestamp,
                    };
                }).sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime()); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤

                pointsLog = logs;
                updateTotalPoints();
                renderPointsLog();
                
                // Show app and hide loading screen after initial load
                loadingScreen.classList.add('hidden');
                appRoot.classList.remove('hidden');
                saveButton.disabled = false; // Enable buttons now that DB is ready
                resetButton.disabled = logs.length === 0;

            }, (error) => {
                console.error("Error listening to Firestore:", error);
                displayError('üö´ ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                // Even on error, hide loading screen to show the error message
                loadingScreen.classList.add('hidden');
                appRoot.classList.remove('hidden');
            });
        };

        /**
         * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡∏°‡πà
         * @param {Event} e
         */
        const handleAddPoints = async (e) => {
            e.preventDefault();
            clearError();
            
            const pointsValue = inputPoints.value;
            const points = parseInt(pointsValue, 10);

            if (isNaN(points) || points <= 0) {
                displayError('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0');
                return;
            }
            if (points > MAX_POINTS_PER_ENTRY) {
                displayError(`üö® ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ñ‡∏∑‡∏≠ ${MAX_POINTS_PER_ENTRY} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`);
                return;
            }

            if (!db || !userId) {
                displayError('‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
                return;
            }

            try {
                const collectionPath = `artifacts/${appId}/users/${userId}/recycling_log`;
                await addDoc(collection(db, collectionPath), {
                    type: selectedRecycleType,
                    points: points,
                    timestamp: new Date(),
                    userId: userId,
                });
                inputPoints.value = ''; // Clear input
                displayError('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', true); 
            } catch (e) {
                console.error("Error adding document: ", e);
                displayError('üö´ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
            }
        };

        /**
         * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
         * @param {string} id - ID ‡∏Ç‡∏≠‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö
         */
        const handleDeleteEntry = async (id) => {
            if (!db || !userId) return;

            try {
                const collectionPath = `artifacts/${appId}/users/${userId}/recycling_log`;
                const docRef = doc(db, collectionPath, id);
                await deleteDoc(docRef);
                displayError('‚ûñ ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', true); 
            } catch (e) {
                console.error("Error deleting document: ", e);
                displayError('üö´ ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
            }
        };

        /**
         * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
         */
        const handleResetAll = async () => {
            if (!db || !userId || isResetting) return;

            // ‡πÉ‡∏ä‡πâ Custom Modal ‡πÅ‡∏ó‡∏ô window.confirm()
            if (!confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ")) {
                return;
            }

            isResetting = true;
            resetButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πâ‡∏≤‡∏á...';
            resetButton.disabled = true;
            displayError('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');

            try {
                const collectionPath = `artifacts/${appId}/users/${userId}/recycling_log`;
                const logsCollection = collection(db, collectionPath);
                // ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ getDocs ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô
                const snapshot = await getDocs(query(logsCollection)); 

                // ‡πÉ‡∏ä‡πâ WriteBatch ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
                const batch = writeBatch(db);
                snapshot.docs.forEach((d) => {
                    batch.delete(d.ref);
                });

                await batch.commit();

                // onSnapshot ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                displayError('üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', true); 
            } catch (e) {
                console.error("Error resetting all logs: ", e);
                displayError('üö´ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
            } finally {
                isResetting = false;
                resetButton.textContent = 'üö® ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
            }
        };

        // --- Initialization ---

        const initializeAppAndAuth = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.warn("Firebase config is missing. Data persistence will be unavailable.");
                    userIdDisplay.textContent = 'CONFIG ERROR';
                    loadingScreen.classList.add('hidden');
                    appRoot.classList.remove('hidden');
                    saveButton.disabled = true;
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Set up Auth Listener
                onAuthStateChanged(auth, async (user) => {
                    if (!user) {
                        try {
                            // Sign in using custom token or anonymously
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (e) {
                            console.error("Authentication failed:", e);
                        }
                    }
                    // Get the final user ID
                    userId = auth.currentUser?.uid || 'anonymous';
                    userIdDisplay.textContent = userId;
                    isAuthReady = true;
                    
                    // Once Auth is ready, set up Firestore listener and enable interactions
                    if (isAuthReady) {
                        setupFirestoreListener();
                    }
                });

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                displayError('üö´ ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Firebase ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console');
                loadingScreen.classList.add('hidden');
                appRoot.classList.remove('hidden');
            }
        };

        // Add event listeners once DOM is loaded
        window.addEventListener('load', () => {
            renderWasteTypeButtons();
            addPointsForm.addEventListener('submit', handleAddPoints);
            resetButton.addEventListener('click', handleResetAll);
            initializeAppAndAuth();
        });

    </script>&nbsp;</p></td>
    </tr>
    <tr>
      <td colspan="4"><img src="img/images/Untitled-5_13.png" width="1024" height="139" alt=""/></td>
    </tr>
  </tbody>
</table>
</body>
</html>
